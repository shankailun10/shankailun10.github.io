# redis多机数据库实现
1. TOC
{:toc}
## 1、主从复制
redis中，用户可以通过执行SLAVEOF master_ip port 命令或设置slaveof配置选项，让一个redis服务器去复制(replicate)
另一台redis服务器的数据, 被复制的服务器为主服务器(master)，复制的服务器为从服务器(slave)。
数据一致性：主服务器和从服务器保持着相同的数据。
### 1.1 旧版复制功能的实现(redis2.8之前)
redis服务器的复制功能分为同步(sync)和命令传播(command propagate)两步。其中同步操作用于将从服务器的数据库状态
更新为和主服务器状态一致；命令传播用于在主服务器数据库状态被修改之后，让主从服务器的数据库状态重新回到一致。
#### 1.1.1 同步
当从服务器使用SLAVEOF master_ip port 命令绑定主服务器并从主服务器复制数据库状态时，从服务器会向主服务器发送
SYNC命令，即执行同步操作。SYNC命令的执行步骤如下：

1. 从服务器向主服务器发送SYNC命令。
2. 主服务器收到SYNC命令之后执行BGSAVE命令，使用子进程在后台生成一个RDB文件，并使用一个缓冲区记录从现在开始执
行的写命令。
3. 主服务器的BGSAVE命令执行完毕，主服务器将生成的RDB文件发送给从服务器，从服务器接受文件并载入文件更新数据库
状态。
4. 主服务器将记录在缓冲区里的所有写命令发送给从服务器，从服务器接收并执行这些写命令，将数据库状态更新至主服
务器当前所处状态。

#### 1.1.2 命令传播
同步操作后主从服务器数据库状态暂时保持一致，后续当主服务器继续执行写命令时，主从服务器的数据库状态将发生变化。
此时，主服务器可通过命令传播操作将主从服务器状态再次达到一致。即：主服务器会将后续的写命令发送给从服务器执行，
以便再次达到一致。
### 1.2 旧版复制功能的缺陷
redis中从服务器对主服务器的复制分为初次复制和断线后重复制两种情况。其中初次复制是指从服务器之前没有复制过主
服务器，或当前复制的主服务器和上一次复制的主服务器不一样；断线后重复制是指处于命令传播阶段的主从服务器因为
网络原因中断了复制，后面从服务器通过自动重连接重新连上了主服务器，并继续复制主服务器。旧版的断线后重复制效率
低下，因为断线重连接后从服务器向主服务器发送的是SYNC命令，主服务器收到SYNC命令后会执行BGSAVE命令生成RDB文件并
使用RDB文件进行数据同步，并不是继续使用命令传播操作发送断线期间主服务器执行的所有写命令。另外SYNC命令也是一个
十分耗时的操作，每次执行SYNC命令后主服务器需要执行BGSAVE命令生成RDB文件，生成过程会耗费主服务器大量的CPU、内存
和磁盘I/O资源；然后主服务器要把生成的RDB文件发送给从服务器，发送操作也会耗费主服务器大量的网络资源(带宽和流量)，
并对主服务器响应请求命令的时间产生影响；从服务器接收并载入RDB文件，在载入期间会阻塞导致没有办法处理命令请求。
### 1.3 新版复制功能的实现(redis2.8版本及以上)
redis2.8版本及以上使用PSYNC命令代替SYNC命令，解决旧版复制功能在断线重连后的复制的低效问题。PSYNC命令具有完整
重同步(full resynchronization)和部分重同步(partial resynchronization)两种模式。其中完整重同步执行步骤同SYNC命
令的同步一致；部分重同步用于处于断线后重复制，当从服务器在断线后重新连接主服务器时，如果条件允许，主服务器会
将主从服务器连接断开期间执行的写命令发送给从服务器，从服务器接收并执行这些写命令使主从数据库状态达到一致。
### 1.4 部分重同步的实现
部分重同步包含三个部分：

1.主服务器的复制偏移量(replication offset)和从服务器的复制偏移量；
2.主服务器的复制积压缓冲区(replication backlog)；
3.服务器运行ID(run ID)。

#### 1.4.1 复制偏移量
主服务器和从服务器分别维护一个复制偏移量。其中主服务器每次向从服务器传播N个字节数据时，主服务器的复制偏移量会加
上N；从服务器每次收到主服务器传来N个字节后将自身的复制偏移量加上N。主从服务器通过对比彼此的复制偏移量来决定数据
库状态是否一致，当偏移量相同时则一致，反之则不一致。
#### 1.4.2 复制积压缓冲区
复制积压缓冲区由主服务器维护的一个固定长度(fixed-size)先进先出(FIFO)队列，默认大小1MB。该队列大小固定，不会随着
队列元素数量增加或减少而发生变化。
当主服务器进行命令传播时，一方面会将写命令发送给所有从服务器，另一方面会将写命令加入复制积压缓冲区队列。即:主服
务器的复制积压缓冲区会保存部分最近传播的命令，并且复制积压缓冲区会为队列中的每个字节记录相应的复制偏移量。当从服
务器重新连上主服务器时，从服务器会通过PSYNC命令将自己的服务偏移量offset发送给主服务器，主服务器根据从服务器的复
制偏移量决定对从服务器执行何种同步操作。

1. 若offset偏移量之后的数据(即offset+1开始的数据)仍然存在于复制积压缓冲区里，主服务器对从服务器执行部分重同步操
作。
2. 若offset偏移量之后的数据不存在于复制积压缓冲区，则主服务器才能对从服务器执行完整同步操作。

##### 1.4.2.1 复制积压缓冲区大小
复制积压缓冲区大小默认为1MB，最小大小计算公式(估算)：second * write_size_per_second。其中second为从服务器断线后
重新连接上主服务器所需的平均时间(单位秒)；write_size_per_second为主服务器平均每秒产生的写命令数据量(协议格式的
写命令的长度总和)。如主服务器平均每秒产生1MB写数据，从服务器断线后平均要5秒能重连上主服务器，则复制积压缓冲区大
小不能低于5MB。一般安全起见，复制积压缓冲区大小取值为最小大小的2倍，即：2 * second * write_size_per_second。
#### 1.4.3 服务器运行ID(run ID)
部分重同步还取决与服务器运行ID。运行ID在服务器启动时自动生成，由40个随机16进制字符组成，主从服务器都有自己的运
行ID。当从服务器对主服务器进行初次复制时，主服务器将自己的运行ID传送给从服务器，从服务器将主服务器的运行ID保存起
来。当从服务器断线并重新连上主服务器时，从服务器向当前连接的主服务器发送保存的运行ID。若从服务器保存的运行ID和
当前连接的主服务器的运行ID相同，则表示连接的是断线重连之前的主服务器，则主服务器进行部分重同步操作；若运行ID不
相同，则表示连接的不是断线重连之前的主服务器，则主服务器进行完整重同步操作。
### 1.5 PSYNC命令的实现
PSYNC命令的两种调用方法。

1. PSYNC ? -1 命令。从服务器之前没有连接过主服务器，或从服务器执行了SLAVEOF no one 命令，则从服务器在开始新的复制
时会向主服务器发送 PSYNC ? -1 命令，主动请求主服务器进行完整重同步操作。
2. PSYNC [runid] [offset] 命令。从服务器已经复制过主服务器，在从服务器开始一次新的复制时会向主服务器发送
PSYNC [runid] [offset] 命令，runid是从服务器保存的上次复制的主服务器的运行ID，offset 是从服务器的当前复制偏移量。
主服务器会根据这两个参数来决定对从服务器进行完整重同步还是部分重同步。

主服务器收到PSYNC命令后会给从服务器返回三种回复中的一种。

1. 主服务器返回+FULLRESYNC [runid] [offset]回复，表示主服务器将与从服务器执行完整重同步操作。其中runid为主服务器
运行ID，offset 为主服务器当前的偏移量。从服务器收到回复后将主服务器run ID保存，将主服务器偏移量作为自身的初始化
偏移量。K
2. 主服务器返回+CONTINUE回复，表示主服务器将与从服务器进行部分重同步操作，从服务器只需等待接收并执行主服务器发
来的自身缺少的写命令即可。
3. 主服务器返回-ERR回复，表示主服务器的版本低于redis2.8，识别不了PSYNC命令，从服务器将向主服务器发送SYNC命令，进
行完整重同步操作。

### 1.6 复制的实现
客户端向从服务器发送SLAVEOF命令，让从服务器复制主服务器。命令为：SLAVEOF [master_ip] [master_port]。复制功能详细
实现步骤为:

1. 设置主服务器的地址和端口
2. 建立套接字连接
3. 发送PING命令
4. 身份验证
5. 发送端口信息
6. 同步
7. 命令传播

#### 1.6.1 设置主服务器的地址和端口
当客户端像从服务器发送SLAVEOF [master_ip] [master_port]命令时，从服务器首先会把主服务器的ip地址和端口保存到
redisServer结构体的masterhost属性和masterport属性。

    # 保存主服务器的ip和端口
    struct redisServer{
        //...
        // 主服务器的ip地址
        char *masterhost;
        // 主服务器的端口
        int masterport;
        //...
    }

其中SLAVEOF命令是异步命令，从服务器在完成masterhost和masterport命令设置之后便会向发送SLAVEOF的客户端返回OK命令，
表示复制指令已经被接收，但是实际的复制工作在返回OK之后才开始。
#### 1.6.2 建立套接字连接
在SLVAVEOF命令执行之后，从服务器器根据ip和端口创建向主服务器的套接字连接，如果能成功连接到主服务器，从服务器会为该套接字
关联专门用于复制工作文件事件处理器，负责接下来的复制工作(接收RDB文件、命令传播等)。主服务器在接受从服务器的套接字连接之后
为该套接字创建相应的客户端状态。
#### 1.6.3 发送PING命令
从服务器成为主服务器的客户端之后，首先会向主服务器发送一个PING命令，ping命令的作用有两个，一是因为虽然主从服务器建立了套
接字连接，但是并没有使用套接字进行过通信，可以通过ping命令检查套接字的读写状态是不是正常；二是检查主服务器是否能正常处理
命令请求，以便后续的复制工作正常进行。从服务器发送ping命令之后，主服务器会返回三种命令回复。

1. 如果主服务器给从服务器返回了一个命令回复，但是从服务器不能在规定时间内读取命令回复的内容，表示主从服务器之间的网络连接
状态不佳，不能即逆行后续的复制操作，此时从服务器会断开并重新创建连向主服务器的套接字。
2. 如果主服务器向从服务器返回一个错误，则表示主服务器暂时没办法处理从服务器的命令请求，不能继续后续的复制操作，从服务器会
断开并重新创建连向主服务器的套接字。
3. 若从服务器读取到主服务器返回的pong回复，则表示主从服务器之间的网络建立正常，且主服务器可以正常处理从服务器发来的命令
请求，从服务器可以继续后续的复制操作。

#### 1.6.4 身份验证
从服务器在收到主服务器返回的pong回复之后，接下来根据从服务器配置的masterauth选项决定是否进行身份验证，配置了该选项则进行
身份验证，否则不进行身份验证。若需要身份验证，从服务器向主服务器发送一条auth命令，命令参数是masterauth选项值。从服务器在
身份验证阶段可能会遇到一下几种情况。

1. 主服务器没有设置requirepass选项，且从服务器也没有设置masterauth选项，则主服务器继续执行从服务器发送的命令，继续后续
复制工作。
2. 若从服务器通过auth命令发送的密码和主服务器requirepass选项相同，则主服务器继续执行从服务器发送的命令，继续后续复制工作，
若不相同则返回一个invalid password错误。
3. 若主服务器设置了requirepass选项，从服务器没有设置masterauth选项，则主服务器返回NOAUTH错误；若主服务器没有设置
requirepass选项，从服务器设置了masterauth选项，则主服务器返回 no password is set错误。

一旦发生错误情况，从服务器都会中止目前的复制工作，并重新创建套接字执行复制操作。

#### 1.6.5 发送端口信息
身份验证通过之后，从服务器向主服务器发送 REPLCONF listening-port [port-number] 命令，告知从服务器监听的端口号。主服务器
接收到命令之后会将端口号记录在从服务器对应的客户端状态的 slave_listening_port属性中。该属性目前唯一作用就是在主服务器上执行
info replication时打印出从服务器的监听端口号。

    # 从服务器对应的客户端状态
    typedef struct redisClient{
        //...
        // 从服务器的监听端口号
        int slave_listening_port;
        //...
    }redisClient;

#### 1.6.6 同步
从服务器向主服务器发送psync命令，执行同步操作，将自身的数据库状态更新至主服务器所处的当前数据库状态。
#### 1.6.7 命令传播
在主从服务器完成同步操作之后，主服务器将进入命令传播阶段，在该阶段中主服务器将自身新增的写命令发送给从服务器，从服务器接收并执行
这些写命令，则主从服务器的状态就可以保持一致。
### 1.7 心跳检测
在命令传播阶段，从服务器默认以每秒一次的频率，向主服务器发送 REPLCONF ACK [replication_offset] 命令。告诉主服务器从服务器
当前的复制偏移量。REPLCONF ACK 命令对主服务器有三个作用：

1. 检测主从服务器的网络连接状态。
2. 辅助实现 min-slaves选项。
3. 检测命令丢失。

#### 1.7.1 检测主从服务器的网络连接状态
主从服务器可通过发送和接受REPLCONF ACK命令检查两者之间的网络通信连接是否正常，若主服务器超过一秒没收到从服务器发来的命令，便知
网络连接有问题。
#### 1.7.2 辅助实现min-slaves配置选项
redis 的 min-slaves-to-write和min-slaves-max-lag两个选项用来防止主服务器在不安全的情况下执行写命令。比如：

    # 选项配置
    min-slaves-to-write 3
    min-slaves-max-lag 10

则在从服务器数量少于3个，或者3个从服务器的延迟(lag)值都大于等于10秒时，主服务器将拒绝执行写命令，lag为主服务器自上次收到从服务器
发来的REPLCONF ACK命令的间隔时间(正常从服务器一秒发一次，该lag值在0-1之间)。
#### 1.7.3 检测命令丢失
由于网络原因，主服务器发送给从服务器的写命令可能会丢失，但是由于从服务器每一秒会发送REPLCONF ACK命令传递从服务器当前复制偏移量给
主服务器，若从服务器当前的偏移量小于主服务器，则主服务器可以知道命令可能丢失，此时会重新在复制积压缓冲区中找到缺失的命令并发送给从
服务器。复制偏移量是redis2.8版本新增的，之前的版本若发生丢失情况主服务器是无从知晓的。






















































