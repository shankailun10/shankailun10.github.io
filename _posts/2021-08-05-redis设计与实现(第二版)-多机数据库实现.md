# redis多机数据库实现
1. TOC
{:toc}
## 1、主从复制
redis中，用户可以通过执行SLAVEOF master_ip port 命令或设置slaveof配置选项，让一个redis服务器去复制(replicate)
另一台redis服务器的数据, 被复制的服务器为主服务器(master)，复制的服务器为从服务器(slave)。
数据一致性：主服务器和从服务器保持着相同的数据。
### 1.1 旧版复制功能的实现(redis2.8之前)
redis服务器的复制功能分为同步(sync)和命令传播(command propagate)两步。其中同步操作用于将从服务器的数据库状态
更新为和主服务器状态一致；命令传播用于在主服务器数据库状态被修改之后，让主从服务器的数据库状态重新回到一致。
#### 1.1.1 同步
当从服务器使用SLAVEOF master_ip port 命令绑定主服务器并从主服务器复制数据库状态时，从服务器会向主服务器发送
SYNC命令，即执行同步操作。SYNC命令的执行步骤如下：

1. 从服务器向主服务器发送SYNC命令。
2. 主服务器收到SYNC命令之后执行BGSAVE命令，使用子进程在后台生成一个RDB文件，并使用一个缓冲区记录从现在开始执
行的写命令。
3. 主服务器的BGSAVE命令执行完毕，主服务器将生成的RDB文件发送给从服务器，从服务器接受文件并载入文件更新数据库
状态。
4. 主服务器将记录在缓冲区里的所有写命令发送给从服务器，从服务器接收并执行这些写命令，将数据库状态更新至主服
务器当前所处状态。

#### 1.1.2 命令传播
同步操作后主从服务器数据库状态暂时保持一致，后续当主服务器继续执行写命令时，主从服务器的数据库状态将发生变化。
此时，主服务器可通过命令传播操作将主从服务器状态再次达到一致。即：主服务器会将后续的写命令发送给从服务器执行，
以便再次达到一致。
### 1.2 旧版复制功能的缺陷
redis中从服务器对主服务器的复制分为初次复制和断线后重复制两种情况。其中初次复制是指从服务器之前没有复制过主
服务器，或当前复制的主服务器和上一次复制的主服务器不一样；断线后重复制是指处于命令传播阶段的主从服务器因为
网络原因中断了复制，后面从服务器通过自动重连接重新连上了主服务器，并继续复制主服务器。旧版的断线后重复制效率
低下，因为断线重连接后从服务器向主服务器发送的是SYNC命令，主服务器收到SYNC命令后会执行BGSAVE命令生成RDB文件并
使用RDB文件进行数据同步，并不是继续使用命令传播操作发送断线期间主服务器执行的所有写命令。另外SYNC命令也是一个
十分耗时的操作，每次执行SYNC命令后主服务器需要执行BGSAVE命令生成RDB文件，生成过程会耗费主服务器大量的CPU、内存
和磁盘I/O资源；然后主服务器要把生成的RDB文件发送给从服务器，发送操作也会耗费主服务器大量的网络资源(带宽和流量)，
并对主服务器响应请求命令的时间产生影响；从服务器接收并载入RDB文件，在载入期间会阻塞导致没有办法处理命令请求。
### 1.3 新版复制功能的实现(redis2.8版本及以上)
redis2.8版本及以上使用PSYNC命令代替SYNC命令，解决旧版复制功能在断线重连后的复制的低效问题。PSYNC命令具有完整
重同步(full resynchronization)和部分重同步(partial resynchronization)两种模式。其中完整重同步执行步骤同SYNC命
令的同步一致；部分重同步用于处于断线后重复制，当从服务器在断线后重新连接主服务器时，如果条件允许，主服务器会
将主从服务器连接断开期间执行的写命令发送给从服务器，从服务器接收并执行这些写命令使主从数据库状态达到一致。
### 1.4 部分重同步的实现
部分重同步包含三个部分：

1.主服务器的复制偏移量(replication offset)和从服务器的复制偏移量；
2.主服务器的复制积压缓冲区(replication backlog)；
3.服务器运行ID(run ID)。

#### 1.4.1 复制偏移量
主服务器和从服务器分别维护一个复制偏移量。其中主服务器每次向从服务器传播N个字节数据时，主服务器的复制偏移量会加
上N；从服务器每次收到主服务器传来N个字节后将自身的复制偏移量加上N。主从服务器通过对比彼此的复制偏移量来决定数据
库状态是否一致，当偏移量相同时则一致，反之则不一致。
#### 1.4.2 复制积压缓冲区
复制积压缓冲区由主服务器维护的一个固定长度(fixed-size)先进先出(FIFO)队列，默认大小1MB。该队列大小固定，不会随着
队列元素数量增加或减少而发生变化。
当主服务器进行命令传播时，一方面会将写命令发送给所有从服务器，另一方面会将写命令加入复制积压缓冲区队列。即:主服
务器的复制积压缓冲区会保存部分最近传播的命令，并且复制积压缓冲区会为队列中的每个字节记录相应的复制偏移量。当从服
务器重新连上主服务器时，从服务器会通过PSYNC命令将自己的服务偏移量offset发送给主服务器，主服务器根据从服务器的复
制偏移量决定对从服务器执行何种同步操作。

1. 若offset偏移量之后的数据(即offset+1开始的数据)仍然存在于复制积压缓冲区里，主服务器对从服务器执行部分重同步操
作。
2. 若offset偏移量之后的数据不存在于复制积压缓冲区，则主服务器才能对从服务器执行完整同步操作。

##### 1.4.2.1 复制积压缓冲区大小
复制积压缓冲区大小默认为1MB，最小大小计算公式(估算)：second * write_size_per_second。其中second为从服务器断线后
重新连接上主服务器所需的平均时间(单位秒)；write_size_per_second为主服务器平均每秒产生的写命令数据量(协议格式的
写命令的长度总和)。如主服务器平均每秒产生1MB写数据，从服务器断线后平均要5秒能重连上主服务器，则复制积压缓冲区大
小不能低于5MB。一般安全起见，复制积压缓冲区大小取值为最小大小的2倍，即：2 * second * write_size_per_second。
#### 1.4.3 服务器运行ID(run ID)
部分重同步还取决与服务器运行ID。运行ID在服务器启动时自动生成，由40个随机16进制字符组成，主从服务器都有自己的运
行ID。当从服务器对主服务器进行初次复制时，主服务器将自己的运行ID传送给从服务器，从服务器将主服务器的运行ID保存起
来。当从服务器断线并重新连上主服务器时，从服务器向当前连接的主服务器发送保存的运行ID。若从服务器保存的运行ID和
当前连接的主服务器的运行ID相同，则表示连接的是断线重连之前的主服务器，则主服务器进行部分重同步操作；若运行ID不
相同，则表示连接的不是断线重连之前的主服务器，则主服务器进行完整重同步操作。
### 1.5 PSYNC命令的实现
PSYNC命令的两种调用方法。

1. PSYNC ? -1 命令。从服务器之前没有连接过主服务器，或从服务器执行了SLAVEOF no one 命令，则从服务器在开始新的复制
时会向主服务器发送 PSYNC ? -1 命令，主动请求主服务器进行完整重同步操作。
2. PSYNC [runid] [offset] 命令。从服务器已经复制过主服务器，在从服务器开始一次新的复制时会向主服务器发送
PSYNC [runid] [offset] 命令，runid是从服务器保存的上次复制的主服务器的运行ID，offset 是从服务器的当前复制偏移量。
主服务器会根据这两个参数来决定对从服务器进行完整重同步还是部分重同步。

主服务器收到PSYNC命令后会给从服务器返回三种回复中的一种。

1. 主服务器返回+FULLRESYNC [runid] [offset]回复，表示主服务器将与从服务器执行完整重同步操作。其中runid为主服务器
运行ID，offset 为主服务器当前的偏移量。从服务器收到回复后将主服务器run ID保存，将主服务器偏移量作为自身的初始化
偏移量。K
2. 主服务器返回+CONTINUE回复，表示主服务器将与从服务器进行部分重同步操作，从服务器只需等待接收并执行主服务器发
来的自身缺少的写命令即可。
3. 主服务器返回-ERR回复，表示主服务器的版本低于redis2.8，识别不了PSYNC命令，从服务器将向主服务器发送SYNC命令，进
行完整重同步操作。

### 1.6 复制的实现
客户端向从服务器发送SLAVEOF命令，让从服务器复制主服务器。命令为：SLAVEOF [master_ip] [master_port]。复制功能详细
实现步骤为:

1. 设置主服务器的地址和端口



































