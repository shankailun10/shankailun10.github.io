# redis单机数据库实现
1. TOC
{:toc}
## 1、数据库
redis 是一个键值对数据库服务器，redis 服务器将所有数据库保存在db 数组中，db 数组的结构如下：

    # db 结构体
    struct redisServer {
        // ...
        // 一个数组，保存服务器中的所有数据库
        redisDb *db;
        // 服务器中的数据库数量
        int dbnum;
        // ...
    } redisDb;
    
其中，dbnum 的值可配置，默认为16，redis 服务器默认会创建16个数据库。
当客户端切换数据库时服务器默认是0号数据库，客户端可使用【SELECT 数据库编号】命令切换到指定的数据库。 
客户端状态 redisClient结构的db属性记录客户端当前正在使用的数据库，redisClient 结构如下：

    # redisClient 结构体
    typedef struct redisClient {
        // ...
        // 一个指向redisDb结构的指针，记录客户端当前正在使用的数据库
        redisDb *db;
        // ...
    } redisDb;

redisDb的结构如下：

    # redidsDb 结构体
    typedef struct redisDb {
        // ...
        // 数据库键空间，保存着数据库中的所有键值对
        dict *dict;
        // 过期字典，保存键的过期时间
        dict *expires;
        // ...
    } redisDb;
    
dict 的键是一个字符串对象，值是字符串对象、列表对象、哈希表对象、集合对象和有序集合对象在内的任意一种 Redis 对象。
expires 过期字典的键是一个指针，指向数据库键空间中的键，值是long long类型的整数，表示键的过期时间，毫秒精度的UNIX时间戳。

### 1.1 redis 数据库键在读取时进行的维护操作
redis 服务器在键读写时除了进行正常读写外，还会进行额外的维护操作，具体如下：

1. 在一个键读取之后(读操作或写操作，写操作也需要读取)，服务器会根据键是否存在来更新键的命中次数和不命中次数。
2. 在一个键读取之后，服务器会计算键的LRU时间，用于计算键的空转时长。
3. 在一个键读取之后，如果键已过期，服务器会先删除该键，然后再进行其他操作。
4. 如果一个键被客户端使用WATCH命令监视之后，服务器在对该键进行修改之后，会将这个键标记为脏(dirty)，事务程序会注意到该键已被修改。
5. 一个键被服务器修改后，服务器会对脏键计数器的值增加一，键计数器会触发服务器的持久化和复制操作。
6. 如果数据库开启了数据库通知功能，则该键被修改后服务器会根据配置发送数据库通知。

### 1.2 设置键的生存时间
redis 客户端可通过EXPIRE或PEXPIRE命令，以秒或毫秒精度为键设置身故生存时间，当生存时间减为0时键就会被redis删除。SETEX可同时设置键值和生存时间。
TTL 命令以秒为单位计算并返回键的剩余生存时间；PTTL 命令以毫秒为单位计算并返回键的剩余生存时间。PERSIST命令清除键的过期时间。
### 1.3 过期键的判定

1. 判断键是否在expires过期键空间内，是读取键的过期时间，否键未过期。
2. 若键在expires中，将当前UNIX时间戳和键的过期时间比较，若UNIX时间戳>键的过期时间，则键过期，否则键未过期。

### 1.4 过期键的删除(定时删除、惰性删除、定期删除)
过期键有三种删除策略，如下：

1. 定时删除：在设置键的过期时间时同时设置一个定时器，在键即将过期时，定时器会自动把键进行删除。
2. 惰性删除：每次从键空间获取键时，检查键是否已过期，过期则进行删除。
3. 定期删除：每隔一段时间，程序对数据库进行一次检查，删除过期键。数据库检查多少个，过期键删除多少个取决于过期键删除算法。

定时删除优点：对内存优好，当键过期时就能及时的删除键并释放键所占用的内存空间；缺点：对CPU时间不优好，当过期键过多时会占用大量的CPU时间，对redis服务器的响应时间和吞吐量造成影响。
惰性删除优点：对CPU时间优化，当键被访问时才进行检查并删除，并且只删除当前键，不会删除其他过期键；缺点：对内存不优好，当过期键过多而且还有很多没有访问到时，服务器并不会去删除这些过期键，导致大量内存被过期键占用，导致内存泄漏(无用的数据占用了大量的内存，服务器却不会主动释放这些数据)。用户手动执行FLUSHDB命令可删除过期键。
定期删除优点：定期删除是定时删除和惰性删除优缺点的一种折中，定期删除每隔一段时间执行一次过期键删除操作，并通过限制删除操作的时长和频率达到CPU时间和内存空间的一种折中。

### 1.5 redis 过期键删除策略
redis 使用惰性删除和定期删除两种策略，其中惰性删除由db.c/expireIfNeeded函数实现，在服务器执行所有读写的命令之前都会先调用该函数，检查指定的键是否过期，过期则删除；
定期删除有redis.c/activeExpireCycle函数实现，当redis服务器运行时，该函数会执行，在规定时间内分多次查找数据库，从数据库中的expires字典中随机查找部分过期键并删除。

### 1.6 AOF、RDB、复制功能对过期键的处理
#### 1.6.1 生成RDB文件
在执行SAVE命令和BGSAVE命令后会创建一个新的RDB文件，服务器会把数据库中的未过期的键放入RDB文件，已过期的键不会存进新创建的RDB文件。
#### 1.6.2 载入RDB文件
在redis服务器启动时，如果开启了RDB功能，服务器就会载入RDB文件。其中，如果服务器是主服务器，在载入RDB文件时，会对RDB文件中的键进行检查并去除已过期的键；如果服务器是从服务器，会把RDB文件中的整个数据一起载入，不过滤过期键。但后面主从服务器数据同步后从服务器数据会被清空，从服务器和主服务器保持一致。
#### 1.6.3 AOF写入
redis服务器开启AOF持久化模式后，服务器中的过期键没有被惰性删除或定期删除，AOF文件不会写入过期键的操作，当过期键被删除时，AOF文件才会过期键被删除的命令。
比如：客户端使用GET message命令获取一个过期键，服务器执行三个步骤：1.GET 从数据库中找到messsage键并删除；2.向AOF文件写入一个DEL message命令；3.向客户端返回一个空回复。
#### 1.6.4 AOF重写
AOF文件重写时已过期的键不会被保存在重写后的AOF文件。
#### 1.6.5 复制
redis服务器运行在复制模式下，从服务器的过期键删除操作由主服务器控制。主服务器删除一个过期键后会向从服务器发送一条DEL命令，从服务器拿到DEL命令后会执行删除操作；在从服务器没收到DEL删除过期键的命令之前，即时客户端GET一个过期键从服务器也不会主动删除过期键，只会把过期键的值直接返回。通过主服务器控制从服务器的过期键删除操作可把持数据库的数据一致性。
### 1.7 数据库通知
数据库通知可以让客户端通过订阅给定的频道或模式，来获知数据库键的变化，以及数据库中命令的执行状态。数据库通知分为键空间通知(关注键执行了哪些命令)和键事件通知(关注某个命令被哪些键执行了)。
键空间通知示例如下，比如客户端执行如下命令：>SUBSCRIBE __keyspace@0__:message 来获取0号数据库中message键执行的所有命令。

```SUBSCRIBE 订阅message键
# SUBSCRIBE 订阅message键
>SUBSCRIBE __keyspace@0__:message
```

    1) "subscribe" // 订阅信息
    2) "__keyspace@0__:message"
    3) (integer) 1
    
    1) "message" // 执行set命令
    2) "__keyspace@0__:message"
    3) "set"
    
    1) "message" // 执行expire命令
    2) "__keyspace@0__:message"
    3) "expire"

键事件通知示例如下，比如客户端执行如下命令：>SUBSCRIBE __keyspace@0__:del 来获取0号数据库中所有执行DEL命令的键。

```SUBSCRIBE 订阅del命令
# SUBSCRIBE 订阅del命令
>SUBSCRIBE __keyspace@0__:del
```

    1) "subscribe" // 订阅信息
    2) "__keyspace@0__:del"
    3) (integer) 1
    
    1) "message" // 键key执行了del命令
    2) "__keyspace@0__:del"
    3) "key"
    
    1) "message" // 键number执行了del命令
    2) "__keyspace@0__:del"
    3) "number"
    
数据库发送的通知类型由redis.conf配置选项notify-keyspacce-events决定。当选项值为AKE时，发送键空间通知和键事件通知；当选项值为AK时，发送键空间通知；当选项值为AE时，发送键事件通知；当选项值为K$时，只发送和字符串键有关的键空间通知；当选项值为El
具体定义如下：

- K     键空间事件，以__keyspace@<db>__前缀发布。
- E     键事件事件，以__keyevent@<db>__前缀发布。
- g     通用命令（非类型特定），如DEL，EXPIRE，RENAME等等
- $     字符串命令
- l     列表命令
- s     集合命令
- h     哈希命令
- z     有序集合命令
- x     过期事件（每次键到期时生成的事件）
- e     被驱逐的事件（当一个键由于达到最大内存而被驱逐时产生的事件）
- A     g$lshzxe的别名，因此字符串AKE表示所有的事件。

## 2、持久化(AOF、RDB)

## 3、事件

## 4、客户端

## 5、服务器
