# redis单机数据库实现
1. TOC
{:toc}
## 1、数据库
redis 是一个键值对数据库服务器，redis 服务器将所有数据库保存在db 数组中，db 数组的结构如下：

    # db 结构体
    struct redisServer {
        // ...
        // 一个数组，保存服务器中的所有数据库
        redisDb *db;
        // 服务器中的数据库数量
        int dbnum;
        // ...
    } redisDb;
    
其中，dbnum 的值可配置，默认为16，redis 服务器默认会创建16个数据库。
当客户端切换数据库时服务器默认是0号数据库，客户端可使用【SELECT 数据库编号】命令切换到指定的数据库。 
客户端状态 redisClient结构的db属性记录客户端当前正在使用的数据库，redisClient 结构如下：

    # redisClient 结构体
    typedef struct redisClient {
        // ...
        // 一个指向redisDb结构的指针，记录客户端当前正在使用的数据库
        redisDb *db;
        // ...
    } redisDb;

redisDb的结构如下：

    # redidsDb 结构体
    typedef struct redisDb {
        // ...
        // 数据库键空间，保存着数据库中的所有键值对
        dict *dict;
        // ...
    } redisDb;
    
dict 的键是一个字符串对象，值是字符串对象、列表对象、哈希表对象、集合对象和有序集合对象在内的任意一种 Redis 对象。

### 1.1 redis 数据库键在读取时进行的维护操作
redis 服务器在键读写时除了进行正常读写外，还会进行额外的维护操作，具体如下：

1. 在一个键读取之后(读操作或写操作，写操作也需要读取)，服务器会根据键是否存在来更新键的命中次数和不命中次数。
2. 在一个键读取之后，服务器会计算键的LRU时间，用于计算键的空转时长。
3. 在一个键读取之后，如果键已过期，服务器会先删除该键，然后再进行其他操作。
4. 如果一个键被客户端使用WATCH命令监视之后，服务器在对该键进行修改之后，会将这个键标记为脏(dirty)，事务程序会注意到该键已被修改。
5. 一个键被服务器修改后，服务器会对脏键计数器的值增加一，键计数器会触发服务器的持久化和复制操作。
6. 如果数据库开启了数据库通知功能，则该键被修改后服务器会根据配置发送数据库通知。

### 1.2 设置键的生存时间
redis 客户端可通过EXPIRE或PEXPIRE命令，以秒或毫秒精度为键设置身故生存时间，当生存时间减为0时键就会被redis删除。SETEX可同时设置键值和生存时间。

## 2、持久化(AOF、RDB)

## 3、事件

## 4、客户端

## 5、服务器
